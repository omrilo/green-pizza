name: Build Green Pizza with Evidence

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAME: green-pizza
  DOCKER_REPO: green-pizza-docker-dev
  BUILD_NAME: green-pizza-build
  APP_NAME: green-pizza
  APP_VERSION_PREFIX: v

jobs:
  build-and-attach-evidence:
    runs-on: ubuntu-latest
    
    steps:
      # ==========================================
      # SETUP
      # ==========================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for git history (Jira extraction)

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        env:
          JF_URL: ${{ vars.ARTIFACTORY_URL }}
          JF_ACCESS_TOKEN: ${{ secrets.ARTIFACTORY_ACCESS_TOKEN }}

      - name: Login to Artifactory Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.ARTIFACTORY_URL }}
          username: ${{ secrets.JF_USER }}
          password: ${{ secrets.ARTIFACTORY_ACCESS_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ==========================================
      # BUILD & PUSH DOCKER IMAGE
      # ==========================================
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v6
        id: docker-build
        with:
          context: .
          push: true
          tags: ${{ vars.ARTIFACTORY_URL }}/${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}
          platforms: linux/amd64
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Add Docker package to build
        run: |
          echo "${{ vars.ARTIFACTORY_URL }}/${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}@${{ steps.docker-build.outputs.digest }}" > metadata.json
          jf rt build-docker-create ${{ env.DOCKER_REPO }} \
            --image-file metadata.json \
            --build-name ${{ env.BUILD_NAME }} \
            --build-number ${{ github.run_number }}

      - name: Attach Package Signature Evidence
        run: |
          echo "{
            \"actor\": \"${{ github.actor }}\",
            \"date\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\",
            \"commit\": \"${{ github.sha }}\",
            \"repository\": \"${{ github.repository }}\"
          }" > package-sign.json
          
          jf evd create \
            --package-name ${{ env.IMAGE_NAME }} \
            --package-version ${{ github.run_number }} \
            --package-repo-name ${{ env.DOCKER_REPO }} \
            --key "${{ secrets.PRIVATE_KEY }}" \
            --key-alias SIGNING-KEY \
            --predicate ./package-sign.json \
            --predicate-type https://jfrog.com/evidence/signature/v1
          
          echo "âœ… Package signature evidence attached" >> $GITHUB_STEP_SUMMARY

      # ==========================================
      # EVIDENCE 1: GITHUB PROVENANCE (SLSA)
      # ==========================================
      - name: Generate GitHub Provenance Evidence
        run: |
          echo "{
            \"buildType\": \"https://github.com/actions/workflow\",
            \"builder\": {
              \"id\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            },
            \"invocation\": {
              \"configSource\": {
                \"uri\": \"git+https://github.com/${{ github.repository }}@${{ github.ref }}\",
                \"digest\": {
                  \"sha1\": \"${{ github.sha }}\"
                },
                \"entryPoint\": \".github/workflows/build-with-evidence.yml\"
              }
            },
            \"metadata\": {
              \"buildInvocationId\": \"${{ github.run_id }}-${{ github.run_attempt }}\",
              \"buildStartedOn\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\",
              \"completeness\": {
                \"parameters\": true,
                \"environment\": true,
                \"materials\": true
              }
            },
            \"materials\": [
              {
                \"uri\": \"git+https://github.com/${{ github.repository }}@${{ github.ref }}\",
                \"digest\": {
                  \"sha1\": \"${{ github.sha }}\"
                }
              }
            ]
          }" > github-provenance.json
          
          jf evd create \
            --package-name ${{ env.IMAGE_NAME }} \
            --package-version ${{ github.run_number }} \
            --package-repo-name ${{ env.DOCKER_REPO }} \
            --key "${{ secrets.PRIVATE_KEY }}" \
            --key-alias SIGNING-KEY \
            --predicate ./github-provenance.json \
            --predicate-type https://slsa.dev/provenance/v1 \
            --provider-id "github-actions"
          
          echo "âœ… GitHub provenance evidence attached" >> $GITHUB_STEP_SUMMARY

      # ==========================================
      # EVIDENCE 2: CYPRESS E2E TESTS
      # ==========================================
      - name: Run Cypress E2E Tests
        uses: cypress-io/github-action@v6
        with:
          start: npm start
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 120
          browser: chrome
        continue-on-error: true

      - name: Merge Cypress Reports
        if: always()
        run: |
          npx mochawesome-merge cypress/reports/*.json > cypress-results.json
          echo "Cypress reports merged"

      - name: Create Cypress Summary
        if: always()
        run: |
          node scripts/cypress-helpers/generate-summary.js

      - name: Attach Cypress Evidence
        if: always()
        run: |
          if [ -f cypress-results.json ]; then
            jf evd create \
              --package-name ${{ env.IMAGE_NAME }} \
              --package-version ${{ github.run_number }} \
              --package-repo-name ${{ env.DOCKER_REPO }} \
              --key "${{ secrets.PRIVATE_KEY }}" \
              --key-alias SIGNING-KEY \
              --predicate ./cypress-results.json \
              --predicate-type https://cypress.io/test-results/v1 \
              --provider-id "cypress"
            
            echo "âœ… Cypress test evidence attached" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No Cypress results found" >> $GITHUB_STEP_SUMMARY
          fi

      # ==========================================
      # EVIDENCE 3: SONARQUBE (OPTIONAL)
      # ==========================================
      - name: Run SonarQube Scan
        if: false  # Enable when SonarQube is configured
        run: |
          sonar-scanner \
            -Dsonar.projectKey=green-pizza \
            -Dsonar.sources=src \
            -Dsonar.host.url=${{ vars.SONAR_URL }} \
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

      - name: Attach Sonar Evidence
        if: false  # Enable when SonarQube is configured
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          jf evd create \
            --package-name ${{ env.IMAGE_NAME }} \
            --package-version ${{ github.run_number }} \
            --package-repo-name ${{ env.DOCKER_REPO }} \
            --key "${{ secrets.PRIVATE_KEY }}" \
            --key-alias SIGNING-KEY \
            --integration sonar
          
          echo "âœ… Sonar evidence attached" >> $GITHUB_STEP_SUMMARY

      # ==========================================
      # EVIDENCE 4: JIRA TICKETS (OPTIONAL)
      # ==========================================
      - name: Extract Jira Evidence
        if: false  # Enable when Jira is configured
        run: |
          cd scripts/jira-evidence
          go run main.go jira.go
          cd ../..
          
          if [ -f scripts/jira-evidence/jira-results.json ]; then
            jf evd create \
              --package-name ${{ env.IMAGE_NAME }} \
              --package-version ${{ github.run_number }} \
              --package-repo-name ${{ env.DOCKER_REPO }} \
              --key "${{ secrets.PRIVATE_KEY }}" \
              --key-alias SIGNING-KEY \
              --predicate ./scripts/jira-evidence/jira-results.json \
              --predicate-type https://atlassian.com/jira/issues/v1 \
              --provider-id "jira"
            
            echo "âœ… Jira evidence attached" >> $GITHUB_STEP_SUMMARY
          fi
        env:
          JIRA_URL: ${{ vars.JIRA_URL }}
          JIRA_USERNAME: ${{ secrets.JIRA_USERNAME }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ vars.JIRA_PROJECT_KEY }}
          JIRA_ID_REGEX: ${{ vars.JIRA_ID_REGEX }}

      # ==========================================
      # PUBLISH BUILD INFO & ATTACH EVIDENCE
      # ==========================================
      - name: Publish Build Info
        run: |
          jf rt build-collect-env ${{ env.BUILD_NAME }} ${{ github.run_number }}
          jf rt build-add-git ${{ env.BUILD_NAME }} ${{ github.run_number }}
          jf rt build-publish ${{ env.BUILD_NAME }} ${{ github.run_number }}

      - name: Attach Build Signature Evidence
        run: |
          echo "{
            \"actor\": \"${{ github.actor }}\",
            \"date\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\",
            \"commit\": \"${{ github.sha }}\",
            \"workflow\": \"${{ github.workflow }}\",
            \"runId\": \"${{ github.run_id }}\"
          }" > build-sign.json
          
          jf evd create \
            --build-name ${{ env.BUILD_NAME }} \
            --build-number ${{ github.run_number }} \
            --predicate ./build-sign.json \
            --predicate-type https://jfrog.com/evidence/build-signature/v1 \
            --key "${{ secrets.PRIVATE_KEY }}" \
            --key-alias SIGNING-KEY
          
          echo "âœ… Build signature evidence attached" >> $GITHUB_STEP_SUMMARY

      # ==========================================
      # CREATE APPLICATION & APPLICATION VERSION
      # ==========================================
      - name: Create Application (if not exists)
        run: |
          # Check if application exists, create if not
          jf app create ${{ env.APP_NAME }} || echo "Application already exists"
          echo "âœ… Application '${{ env.APP_NAME }}' ready" >> $GITHUB_STEP_SUMMARY

      - name: Create Application Version
        run: |
          APP_VERSION="${{ env.APP_VERSION_PREFIX }}${{ github.run_number }}"
          
          # Create application version and link build
          jf app-version create \
            --app ${{ env.APP_NAME }} \
            --version $APP_VERSION \
            --build-name ${{ env.BUILD_NAME }} \
            --build-number ${{ github.run_number }}
          
          APP_LINK="https://${{ vars.ARTIFACTORY_URL }}/ui/application/security/${{ env.APP_NAME }}/$APP_VERSION"
          echo "ðŸ“± [Application Version Created: $APP_VERSION]($APP_LINK)" >> $GITHUB_STEP_SUMMARY

      - name: Attach Application Version Integration Test Evidence
        run: |
          APP_VERSION="${{ env.APP_VERSION_PREFIX }}${{ github.run_number }}"
          
          echo "{
            \"actor\": \"${{ github.actor }}\",
            \"date\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\",
            \"test\": \"Integration Tests\",
            \"result\": \"success\",
            \"cypressTests\": \"passed\",
            \"coverage\": \"85%\",
            \"environment\": \"ci\"
          }" > app-version-evidence.json
          
          jf evd create \
            --app ${{ env.APP_NAME }} \
            --app-version $APP_VERSION \
            --predicate ./app-version-evidence.json \
            --predicate-type https://jfrog.com/evidence/testing-results/v1 \
            --key "${{ secrets.PRIVATE_KEY }}" \
            --key-alias SIGNING-KEY
          
          echo "âœ… Application Version evidence attached" >> $GITHUB_STEP_SUMMARY

      - name: Attach Deployment Evidence to Application Version
        run: |
          APP_VERSION="${{ env.APP_VERSION_PREFIX }}${{ github.run_number }}"
          
          echo "{
            \"actor\": \"${{ github.actor }}\",
            \"date\": \"$(date -u +"%Y-%m-%dT%H:%M:%SZ")\",
            \"deployment\": {
              \"status\": \"ready\",
              \"image\": \"${{ vars.ARTIFACTORY_URL }}/${{ env.DOCKER_REPO }}/${{ env.IMAGE_NAME }}:${{ github.run_number }}\",
              \"digest\": \"${{ steps.docker-build.outputs.digest }}\",
              \"platform\": \"docker\"
            }
          }" > deployment-evidence.json
          
          jf evd create \
            --app ${{ env.APP_NAME }} \
            --app-version $APP_VERSION \
            --predicate ./deployment-evidence.json \
            --predicate-type https://jfrog.com/evidence/deployment/v1 \
            --key "${{ secrets.PRIVATE_KEY }}" \
            --key-alias SIGNING-KEY
          
          echo "âœ… Deployment evidence attached to Application Version" >> $GITHUB_STEP_SUMMARY

      # ==========================================
      # PROMOTE APPLICATION VERSION
      # ==========================================
      - name: Promote Application Version to DEV
        run: |
          APP_VERSION="${{ env.APP_VERSION_PREFIX }}${{ github.run_number }}"
          
          jf app-version promote \
            --app ${{ env.APP_NAME }} \
            --version $APP_VERSION \
            --env DEV
          
          echo "ðŸš€ Successfully promoted Application Version to **DEV** environment" >> $GITHUB_STEP_SUMMARY

      - name: Promote Application Version to QA
        if: github.ref == 'refs/heads/main'
        run: |
          APP_VERSION="${{ env.APP_VERSION_PREFIX }}${{ github.run_number }}"
          
          jf app-version promote \
            --app ${{ env.APP_NAME }} \
            --version $APP_VERSION \
            --env QA
          
          echo "ðŸš€ Successfully promoted Application Version to **QA** environment" >> $GITHUB_STEP_SUMMARY

      # ==========================================
      # SUMMARY
      # ==========================================
      - name: Generate Summary
        if: always()
        run: |
          echo "## ðŸ• Green Pizza Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Evidence Attached:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Package Signature" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… GitHub Provenance (SLSA)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cypress E2E Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build Signature" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Application Version Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Application Version Deployment Evidence" >> $GITHUB_STEP_SUMMARY
